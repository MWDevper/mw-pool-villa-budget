<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pool Villa Budget App</title>
    <style>
        /* BASE & MOBILE-FIRST STYLES */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px; /* จำกัดความกว้างสำหรับมือถือ */
            margin: 0 auto;
            padding: 15px;
            box-sizing: border-box;
        }

        /* HEADER & STATUS BAR */
        header {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        /* BALANCE DISPLAY */
        #balance-display {
    text-align: center;
    padding: 10px 0;
    margin-bottom: 10px;
    font-size: 1.2em;
    font-weight: bold;
    background-color: #ffffff; /* พื้นหลังสีขาว */
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.balance-positive {
    color: #28a745; /* สีเขียว */
}

.balance-negative {
    color: #dc3545; /* สีแดง */
}
        #account-name-display {
            font-weight: bold;
            font-size: 1.1em;
            /* เพิ่ม user info container */
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        #user-greeting-display {
            font-size: 0.8em;
            opacity: 0.9;
            margin-top: 2px;
        }
        #current-datetime {
            font-size: 0.85em;
            opacity: 0.8;
            text-align: right;
        }

        /* LOGIN SCREEN STYLES */
        #login-screen {
            padding: 40px 15px;
            text-align: center;
        }
        .login-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        
        /* BUTTON STYLES (Modern & Mobile-friendly) */
        .btn-primary {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
            margin-top: 10px;
        }
        .btn-login {
            background-color: #28a745;
            color: white;
        }
        .btn-login:hover:not(:disabled) {
            background-color: #218838;
        }
        .btn-action {
            background-color: #007bff;
            color: white;
            margin-bottom: 15px;
        }
        .btn-action:hover:not(:disabled) {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #5a6268;
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* MAIN CONTENT AREA */
        .content-section {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }

        /* NAVIGATION TABS (Mobile-friendly Grid) */
        .tab-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 ปุ่มต่อแถว */
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 15px;
            border: 2px solid #007bff;
            border-radius: 10px;
            background-color: white;
            color: #007bff;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .tab-button.active {
            background-color: #007bff;
            color: white;
        }
        
        /* FORM LAYOUT (Simplified for Mobile) */
        .form-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        .form-row label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .form-row input[type="number"],
        .form-row input[type="text"] {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        /* TABLE STYLES (Mobile-friendly) */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .data-table th, .data-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .data-table th {
            background-color: #e9ecef;
            font-weight: bold;
            color: #495057;
        }
        /* ในส่วน <style> ของ poolvilla2.html */

/* TABLE STYLES (Mobile-friendly, Compact) */
.transaction-table {
    width: 100%;
    border-collapse: collapse; /* ยุบขอบตาราง */
    margin-top: 10px;
    font-size: 0.85em; /* ✅ FIX: ปรับขนาดตัวอักษรให้เล็กลง */
}

.transaction-table th, .transaction-table td {
    padding: 8px 5px; /* ลด Padding ให้กระชับขึ้น */
    border-bottom: 1px solid #eee;
    text-align: left;
}

.transaction-table th {
    background-color: #f4f4f4;
    font-weight: bold;
    color: #555;
    position: sticky; /* ทำให้หัวตารางติดด้านบนเมื่อเลื่อน (Scroll) */
    top: 0;
    z-index: 10;
}

.transaction-table td:nth-child(2) { /* คอลัมน์ "ประเภท/จำนวน" */
    text-align: right;
    white-space: nowrap; 
    font-weight: bold;
}

.transaction-table td:nth-child(3) { /* คอลัมน์ "ลบ" */
    text-align: center; /* ให้ปุ่มลบอยู่ตรงกลาง */
}

.transaction-table .income-row {
    background-color: #e6ffe6; /* พื้นหลังสีเขียวอ่อนสำหรับรายรับ */
}

.transaction-table .expense-row {
    background-color: #fff0f0; /* พื้นหลังสีชมพูอ่อนสำหรับรายจ่าย */
}

/* ปรับขนาดปุ่ม "ลบ" ให้เล็กลง */
.transaction-table .delete-btn {
    padding: 3px 6px;
    font-size: 0.75em;
    margin-left: 0; 
}

/* เพิ่มคลาสสีที่ใช้ในตาราง */
.text-success { color: #28a745; }
.text-danger { color: #dc3545; }
/* เพิ่ม CSS สำหรับทำให้รายการเลื่อนได้ */
        .scrollable-list {
            max-height: 400px; /* กำหนดความสูงสูงสุด (ปรับเปลี่ยนได้ตามต้องการ) */
            overflow-y: auto; /* เปิดใช้งานแถบเลื่อนแนวตั้ง */
            border: 1px solid #ccc; /* เพิ่มขอบเพื่อให้ดูเป็นกล่องรายการ */
            border-radius: 8px;
            padding: 0 10px; /* เพิ่ม padding ด้านข้างเล็กน้อย */
        }
        
        /* ALERT/TOAST NOTIFICATION (Stylish) */
        #notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            z-index: 2000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .success { background-color: #28a745; }
        .error { background-color: #dc3545; }
        .info { background-color: #ffc107; color: #333; }
        .show { opacity: 1; display: block; }

        /* FOOTER & LOGOUT */
        footer {
            text-align: center;
            padding: 15px;
            margin-top: auto;
            color: #888;
            font-size: 0.8em;
        }
        #logout-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            opacity: 0.8;
            transition: opacity 0.3s;
        }
        #logout-btn:hover {
            opacity: 1;
        }
        /* New Budget Display Style */
#budget-display {
    text-align: center;
    padding: 10px 0;
    margin-bottom: 5px; 
    font-size: 1.1em;
    font-weight: bold;
    background-color: #e3f2fd; /* สีฟ้าอ่อน */
    color: #0d47a1; /* สีน้ำเงินเข้ม */
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

#total-budget-amount {
    font-size: 1.2em;
    font-weight: bold;
    display: block; /* ขึ้นบรรทัดใหม่เพื่อเน้น */
    margin-top: 5px;
}
    </style>
</head>
<body>

    <div id="notification"></div>

    <header>
        <div>
            <div id="account-name-display">กำลังโหลด...</div>
        </div>
        <div>
            <span id="current-datetime"></span>
            <button id="logout-btn" style="display: none;">ออกจากระบบ</button>
        </div>
    </header>

    <div class="container">

        <section id="login-screen">
            <h2>เข้าสู่ระบบ</h2>
            <input type="password" id="passcode" class="login-input" placeholder="รหัสผ่าน" required>
            <input type="text" id="username" class="login-input" placeholder="ชื่อผู้ใช้งาน" required>
            <button id="login-btn" class="btn-primary btn-login" onclick="login()">เข้าสู่ระบบ</button>
        </section>

        <section id="app-screen" style="display: none;">

    <div id="budget-display">
        <strong>Budget รวม (รายรับ) :</strong> 
        <span id="total-budget-amount">กำลังคำนวณ...</span>
    </div>

            <div id="balance-display">
    กำลังคำนวณยอดคงเหลือ...
            </div>

            <div id="estimate-total-display" style="
                    text-align: center; 
                    padding: 5px 0; 
                    margin-bottom: 10px; 
                    font-size: 1.0em; 
                    color: #ffc107; /* สีเหลืองสำหรับคำเตือน */
                    font-weight: bold;
                    display: none; /* ซ่อนไว้ก่อน */
                    ">
                    ยอดประเมินจ่ายรวม: 
                    <span class="estimate-amount">0.00 บาท</span>
            </div>
            
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('add')">เพิ่มรายการ</button>
                <button class="tab-button" onclick="showTab('estimate')">รายการประเมินจ่ายล่วงหน้า</button>
            </div>

            <div id="add-tab" class="content-section">
                <h2>เพิ่มรายการ รายรับ/รายจ่าย</h2>
                
                <div class="tab-buttons" style="margin-bottom: 15px;">
                    <button id="btn-expense" class="tab-button active" data-type="EXPENSE">รายจ่าย</button>
                    <button id="btn-income" class="tab-button" data-type="INCOME">รายรับ</button>
                </div>

                <div class="form-row">
                    <label for="transaction-description">รายละเอียด</label>
                    <input type="text" id="transaction-description" placeholder="ค่าอาหาร, ค่าเดินทาง, อื่นๆ" required>
                </div>

                <div class="form-row">
                    <label for="transaction-amount">ยอดเงิน</label>
                    <input type="number" id="transaction-amount" placeholder="0.00" required>
                </div>

                <button class="btn-primary btn-action" onclick="addTransaction()">บันทึกรายการ</button>
            </div>
                <div class="list-section">
                    <h2>รายการบัญชี (รับ-จ่าย)</h2>
    
                    <div id="transactions-container" class="scrollable-list">
                        <table id="transactions-table" class="transaction-table">
                            <thead>
                                <tr>
                                    <th style="width: 50%;">รายละเอียด</th>
                                    <th style="width: 30%; text-align: right;">จำนวน</th>
                                    <th style="width: 20%;"></th> </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="3" class="no-data">ไม่มีรายการรับ-จ่าย</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            <div id="estimate-tab" class="content-section" style="display: none;">
                <h2>รายการประเมินจ่ายล่วงหน้า</h2>
                <div style="font-weight: bold; margin-bottom: 15px;">ยอดรวมประเมิน: <span id="total-estimate-display">0.00</span></div>

                <div id="estimate-list-container">
                    <table id="estimates-table" class="transaction-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">รายละเอียด</th>
                                <th style="width: 30%; text-align: right;">จำนวน</th>
                                <th style="width: 15%; text-align: center;">เปลี่ยนเป็น</th> <th style="width: 15%; text-align: center;">ลบ</th> </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="4" class="no-data">ไม่มีรายการประเมิน</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="content-section" style="margin-top: 15px;">
                    <h3>เพิ่มรายการประเมิน</h3>
                    
                    <div class="form-row">
                        <label for="estimate-description">รายละเอียดประเมิน</label>
                        <input type="text" id="estimate-description" placeholder="ค่ามัดจำ, ค่าเข้าชม" required>
                    </div>

                    <div class="form-row">
                        <label for="estimate-amount">ยอดเงินประเมิน</label>
                        <input type="number" id="estimate-amount" placeholder="0.00" required>
                    </div>

                    <button class="btn-primary btn-action" onclick="addEstimate()">เพิ่มรายการประเมิน</button>
                </div>
            </div>

            <div id="data-display-section">
                </div>

            <div class="content-section">
                <h3>ยอดผู้เข้าชมทั้งหมด</h3>
                <p style="font-size: 1.5em; font-weight: bold;" id="visitor-count">กำลังโหลด...</p>
            </div>

            <div class="content-section">
                <h3>ประวัติการดำเนินการล่าสุด</h3>
                <pre id="log-display"></pre>
            </div>
            

        </section>
    </div>

    <footer>
        <p>Pool Villa Budget App | Make by K-mew</p>
    </footer>

    <script>
        // *** 1. CONFIGURATION & STATE ***
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyaxvPma9VT6xAK9-dHIxEi4-v7NAtHTg7MLtdc4lG42Nw_N8QwwhWkdQyJ7hGr8EXsbA/exec'; // *** อย่าลืมเปลี่ยนเป็น URL ของคุณ ***
        let currentTab = 'add';
        let transactionType = 'EXPENSE'; 
        const LOGGED_IN_USER_KEY = 'budgetAppUser'; 
        const LOGGED_IN_PASSCODE_KEY = 'budgetAppPasscode'; 

        // ✅ FIX 1: เพิ่มการประกาศตัวแปรหลัก
let transactionsData = []; 
let estimatesData = [];
let logsData = [];

        // *** 2. CORE UTILITY FUNCTIONS ***

        // Utility: Show stylish notification (Toast)
        function showNotification(message, type = 'info', duration = 3000) {
            const notif = document.getElementById('notification');
            notif.className = ''; 
            notif.classList.add(type, 'show');
            notif.textContent = message;
            notif.style.display = 'block';
            
            if (duration > 0 && duration !== 60000) { 
                setTimeout(() => {
                    notif.classList.remove('show');
                    setTimeout(() => {
                        notif.style.display = 'none';
                    }, 500);
                }, duration);
            }
        }

        // Utility: Update current date/time display
        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('th-TH', { 
                year: 'numeric', month: 'short', day: 'numeric' 
            });
            const timeStr = now.toLocaleTimeString('th-TH', { 
                hour: '2-digit', minute: '2-digit' 
            });
            document.getElementById('current-datetime').textContent = `${dateStr} ${timeStr}`;
        }
        setInterval(updateDateTime, 1000); 
        updateDateTime(); 

        // Core API Call (Uses GET method for all data exchange)
// Core API Call (Uses GET method for all data exchange)
// Core API Call (Uses GET method for all data exchange)
// Core API Call (Uses GET method for all data exchange)
async function postData(payload) {
    document.querySelectorAll('.btn-primary, .btn-secondary').forEach(btn => btn.disabled = true);
    showNotification('รอสักครู่...', 'info', 60000); 

    const queryString = Object.keys(payload)
        .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(payload[key]))
        .join('&');

    const get_url = WEB_APP_URL + '?' + queryString;
    
    try {
        const response = await fetch(get_url, {
            method: 'GET'
        });

        // 1. ตรวจสอบสถานะ HTTP (รวมถึง 404)
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`HTTP Error Status: ${response.status}`, errorText);
            
            // ส่งกลับ Error ที่ชัดเจน
            return { success: false, message: `Server ตอบกลับ Error ${response.status} (อาจเป็น URL ผิด/สิทธิ์เข้าถึงผิด)` };
        }
        
        // 2. พยายามแปลงเป็น JSON
        const responseText = await response.text();
        
        try {
            const result = JSON.parse(responseText);
            
            // ถ้าเป็นรายการแก้ไข/เพิ่มสำเร็จ ให้ทำการโหลดข้อมูลใหม่
            if (result.success && ['ADD_TRANSACTION', 'ADD_ESTIMATE', 'DELETE_TRANSACTION', 'DELETE_ESTIMATE', 'FORWARD_ESTIMATE'].includes(payload.action)) {
                 await loadAllData(); 
            }
            
            return result;
        } catch (e) {
            console.error("Failed to parse JSON:", responseText, e);
            // กรณี Apps Script ส่ง HTML หรือ Text อื่นๆ กลับมา
            return { success: false, message: 'Server ส่งข้อมูลกลับมาผิดรูปแบบ (ไม่ใช่ JSON)' };
        }

    } catch (error) {
        console.error("Fetch/Server Connection Error:", error);
        return { success: false, message: 'การเชื่อมต่อ Network ล้มเหลว' };
    } finally {
        document.querySelectorAll('.btn-primary, .btn-secondary').forEach(btn => btn.disabled = false);
        document.getElementById('notification').classList.remove('show', 'info');
        document.getElementById('notification').style.display = 'none';
    }
}
        
        // *** 3. UI MANAGEMENT ***

        function showTab(tabName) {
            document.getElementById('add-tab').style.display = tabName === 'add' ? 'block' : 'none';
            document.getElementById('estimate-tab').style.display = tabName === 'estimate' ? 'block' : 'none';
            
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-buttons button[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            currentTab = tabName;
        }

        document.getElementById('btn-expense').addEventListener('click', function() {
            document.getElementById('btn-expense').classList.add('active');
            document.getElementById('btn-income').classList.remove('active');
            transactionType = 'EXPENSE';
        });
        document.getElementById('btn-income').addEventListener('click', function() {
            document.getElementById('btn-income').classList.add('active');
            document.getElementById('btn-expense').classList.remove('active');
            transactionType = 'INCOME';
        });

        // *** 4. LOGIN & AUTHENTICATION (แก้ไข Autologin/Refresh) ***

        // Load account name (Pool Villa) using a 'System' GET request
async function loadAccountName() {
    document.getElementById('account-name-display').innerHTML = 'กำลังโหลดบัญชี...'; 
    
    const payload = { action: 'LOGIN', passcode: '000000', user: 'System' };
    
    // ✅ ต้องมี await ตรงนี้เพื่อรอผลลัพธ์ก่อนจะไปบรรทัดถัดไป
    const result = await postData(payload); 

    if (result.success && result.accountName) {
        document.getElementById('account-name-display').innerHTML = `
            <span>${result.accountName}</span>
        `;
        return true; 
    } else {
        // จะแสดงข้อความ Error จาก postData แทน Error ที่พังใน Console
        document.getElementById('account-name-display').innerHTML = `
            <span style="color: red;">บัญชีหลัก: โหลดล้มเหลว</span>
        `;
        showNotification(`โหลดบัญชีล้มเหลว: ${result.message || 'ข้อผิดพลาดไม่ทราบสาเหตุ'}`, 'error', 10000);
        return false; 
    }
}

        // Check for stored credentials on load
        async function checkAutoLogin() { 
            // 1. โหลดชื่อบัญชี Pool Villa (บัญชีหลัก) เสมอ และต้องรอให้เสร็จ
            await loadAccountName(); 
            
            const storedUser = localStorage.getItem(LOGGED_IN_USER_KEY);
            const storedPasscode = localStorage.getItem(LOGGED_IN_PASSCODE_KEY);
            
            if (storedUser && storedPasscode) {
                document.getElementById('username').value = storedUser;
                document.getElementById('passcode').value = storedPasscode;
                
                // 2. พยายาม Auto-login และต้องรอผลลัพธ์
                const loginSuccess = await login(true); 
                
                if (!loginSuccess) {
                    document.getElementById('login-screen').style.display = 'block';
                    document.getElementById('app-screen').style.display = 'none';
                }
            } else {
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('app-screen').style.display = 'none';
            }
        }
        
        // User Login function
// User Login function
// User Login function
// User Login function
// User Login function
// User Login function
// User Login function
// User Login function
// ในไฟล์ poolvilla1.html
async function login(isAuto = false) {
    const passcode = document.getElementById('passcode').value.trim();
    const user = document.getElementById('username').value.trim();
    
    if (!passcode || !user) {
        showNotification('กรุณากรอกรหัสผ่านและชื่อผู้ใช้งาน', 'info');
        return false;
    }

    const loginBtn = document.getElementById('login-btn');
    loginBtn.disabled = true;

    // ส่งสถานะ isAuto ไปให้ Backend ด้วย
    const payload = { action: 'LOGIN', passcode: passcode, user: user, isAuto: isAuto }; 
    const result = await postData(payload);

    loginBtn.disabled = false; 

    if (result.success) {
        // ... (Login สำเร็จ) ...
        localStorage.setItem(LOGGED_IN_USER_KEY, user);
        localStorage.setItem(LOGGED_IN_PASSCODE_KEY, passcode);
        
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'block';
        
        document.getElementById('account-name-display').innerHTML = `
            <span>${result.accountName}</span>
            <span id="user-greeting-display">Make by K-mew, คุณ ${result.user}</span>
        `;
        document.getElementById('logout-btn').style.display = 'inline';
        
        showNotification('เข้าสู่ระบบสำเร็จ', 'success');
        setTimeout(loadAllData, 100); 
        return true;

    } else {
        // ✅ ถ้า Login ล้มเหลว ให้แสดงข้อความ Error จาก Backend ทันที
        showNotification(`เข้าสู่ระบบล้มเหลว: ${result.message || 'ข้อผิดพลาดไม่ทราบสาเหตุ'}`, 'error');
        
        // ถ้า Auto-login ล้มเหลว ให้เคลียร์ Local Storage เพื่อบังคับให้ผู้ใช้ต้องกรอกใหม่
        if (isAuto) {
             localStorage.removeItem(LOGGED_IN_USER_KEY);
             localStorage.removeItem(LOGGED_IN_PASSCODE_KEY);
             await loadAccountName();
             document.getElementById('login-screen').style.display = 'block';
             document.getElementById('app-screen').style.display = 'none';
        }
        return false;
    }
}

        async function logout() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            await postData({ action: 'LOGOUT', user: user });
            
            localStorage.removeItem(LOGGED_IN_USER_KEY);
            localStorage.removeItem(LOGGED_IN_PASSCODE_KEY);
            
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('app-screen').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'none';
            
            // แก้ไข: โหลดชื่อบัญชีหลักกลับมาแสดงใน Header
            await loadAccountName(); 
            
            showNotification('ออกจากระบบแล้ว', 'info');
        }
        document.getElementById('logout-btn').addEventListener('click', logout);

        // *** 5. DATA ACTIONS ***
        
        async function addTransaction() {
            const description = document.getElementById('transaction-description').value.trim();
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);

            if (!description || isNaN(amount) || amount <= 0) {
                showNotification('กรุณากรอกรายละเอียดและยอดเงินที่ถูกต้อง', 'info');
                return;
            }

            const payload = { 
                action: 'ADD_TRANSACTION', user: user, type: transactionType, description: description, amount: amount
            };
            
            const result = await postData(payload);
            
            if (result.success) {
                showNotification('บันทึกรายการสำเร็จ', 'success');
                document.getElementById('transaction-description').value = '';
                document.getElementById('transaction-amount').value = '';
            } else {
                showNotification(`บันทึกรายการล้มเหลว: ${result.message || 'ข้อผิดพลาด'}`, 'error');
            }
        }
        
        async function addEstimate() {
            const description = document.getElementById('estimate-description').value.trim();
            const amount = parseFloat(document.getElementById('estimate-amount').value);
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);

            if (!description || isNaN(amount) || amount <= 0) {
                showNotification('กรุณากรอกรายละเอียดและยอดเงินประเมินที่ถูกต้อง', 'info');
                return;
            }

            const payload = { 
                action: 'ADD_ESTIMATE', user: user, description: description, amount: amount
            };
            
            const result = await postData(payload);
            
            if (result.success) {
                showNotification('เพิ่มรายการประเมินสำเร็จ', 'success');
                document.getElementById('estimate-description').value = '';
                document.getElementById('estimate-amount').value = '';
            } else {
                showNotification(`เพิ่มรายการประเมินล้มเหลว: ${result.message || 'ข้อผิดพลาด'}`, 'error');
            }
        }

        // *** 6. DATA DISPLAY ***
        
// ในไฟล์ poolvilla1.html
// ... (ฟังก์ชันอื่น ๆ) ...

// Core Data Loading
// ในไฟล์ poolvilla2.html (ประมาณบรรทัด 660)

// Core Data Loading
async function loadAllData() {
    showNotification('กำลังโหลดข้อมูล...', 'info', 60000); 
    const payload = { action: 'GET_DATA' };
    const result = await postData(payload);

    if (result.success) {
        // อัปเดตตัวแปรหลัก
        transactionsData = result.transactions;
        estimatesData = result.estimates;
        logsData = result.logs;
        
        // ❌ ลบบรรทัดที่เคยเรียก renderData(transactionsData, estimatesData); ออก
        
        // ✅ FIX 2: เรียกใช้ฟังก์ชันแสดงผลทีละส่วนอย่างถูกต้อง
        renderTransactionData(transactionsData); 
        renderEstimateData(estimatesData);
        renderOverview(result); 
        renderLogs(logsData); 

        showNotification('โหลดข้อมูลสำเร็จ', 'success');
    } else {
        showNotification(`โหลดข้อมูลล้มเหลว: ${result.message || 'ข้อผิดพลาด'}`, 'error');
    }
}
// ... (ฟังก์ชันอื่น ๆ) ...
        
// ในไฟล์ poolvilla2.html (ประมาณบรรทัด 700)
function renderTransactionData(transactions) {
    // ✅ FIX 3: เปลี่ยนไปใช้ ID ของ <tbody> ของตาราง
    const listElement = document.querySelector('#transactions-table tbody'); 
    listElement.innerHTML = ''; 

    if (!transactions || transactions.length === 0) {
        listElement.innerHTML = '<tr><td colspan="3" class="no-data">ไม่มีรายการรับ-จ่าย</td></tr>';
        return;
    }
    
    // สลับลำดับ (Reverse) และ จำกัดจำนวน (Slice) ให้โชว์ 10 รายการล่าสุด
    const latestTransactions = transactions.slice().reverse().slice(0, 10);

    latestTransactions.forEach((t) => {
        const typeClass = t.Type === 'INCOME' ? 'income-row' : 'expense-row';
        const typeTextClass = t.Type === 'INCOME' ? 'text-success' : 'text-danger';
        const typeLabel = t.Type === 'INCOME' ? 'รับ' : 'จ่าย';
        
        const amount = (parseFloat(t.Amount) || 0).toLocaleString('th-TH', { minimumFractionDigits: 2 });
        
        const row = document.createElement('tr');
        row.className = `${typeClass}`; // กำหนดสีพื้นหลังตามประเภท

        // โครงสร้างตาราง (3 คอลัมน์)
        row.innerHTML = `
            <td>
                ${t.Description || '-'} 
                <div style="font-size: 0.7em; color: #888;">${t.Timestamp} | โดย ${t.User}</div>
            </td>
            <td class="${typeTextClass}">
                ${typeLabel}<br>
                ${amount}
            </td>
            <td style="text-align: center;">
                <button onclick="deleteTransaction('${t.Type}', ${t['Data Index']})" class="delete-btn">ลบ</button>
            </td>
        `;
        listElement.appendChild(row);
    });
}

// ในไฟล์ poolvilla2.html (ประมาณบรรทัด 750)
function renderEstimateData(estimates) {
    // 1. จัดการ Total Estimate Display
    let totalEstimate = 0;
    estimates.forEach(e => {
        totalEstimate += parseFloat(e.Amount) || 0;
    });

    document.getElementById('total-estimate-display').textContent = totalEstimate.toLocaleString('th-TH', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    });

    // 2. จัดการตารางแสดงรายการ
    const listElement = document.querySelector('#estimates-table tbody'); 
    
    // ตรวจสอบความถูกต้องของ Element
    if (!listElement) return; 

    listElement.innerHTML = ''; 

    if (!estimates || estimates.length === 0) {
        // colspan=4 สำหรับ 4 คอลัมน์ (รายละเอียด, จำนวน, จ่ายจริง, ลบ)
        listElement.innerHTML = '<tr><td colspan="4" class="no-data">ไม่มีรายการประเมิน</td></tr>';
        return;
    }
    
    // โชว์รายการประเมินทั้งหมด
    estimates.forEach((e) => {
        const amount = (parseFloat(e.Amount) || 0).toLocaleString('th-TH', { minimumFractionDigits: 2 });
        
        const row = document.createElement('tr');
        row.className = 'estimate-row'; // สไตล์สำหรับรายการประเมิน

        row.innerHTML = `
            <td>
                ${e.Description || '-'} 
                <div style="font-size: 0.7em; color: #888;">${e.Timestamp} | โดย ${e.User}</div>
            </td>
            <td style="text-align: right; color: #ffc107;">
                ${amount}
            </td>
            <td style="text-align: center;">
                <button onclick="forwardEstimate(${e['Data Index']})" class="forward-btn" style="
                    background-color: #28a745; 
                    color: white; 
                    padding: 3px 6px; 
                    font-size: 0.75em; 
                    border: none; 
                    border-radius: 4px;
                ">จ่าย</button>
            </td>
            <td style="text-align: center;">
                <button onclick="deleteEstimate(${e['Data Index']})" class="delete-btn">ลบ</button>
            </td>
        `;
        listElement.appendChild(row);
    });
}
        
// ในไฟล์ poolvilla2.html (ประมาณบรรทัด 780)

function renderLogs(logs) { // ✅ FIX 3: ใช้ชื่อ parameter เป็น logs เฉยๆ ก็ได้ แต่ต้องใช้ตัวแปรนี้ข้างใน
    const logElement = document.getElementById('log-display');
    if (logs && logs.length > 0) { // ✅ เพิ่มการตรวจสอบ logs เพื่อป้องกัน Error
        // แสดง 10 รายการล่าสุด
        const latestLogs = logs.slice(-10).reverse();
        logElement.textContent = latestLogs.map(log => 
            `[${log.Timestamp}] ${log.User}: ${log.Action}`
        ).join('\n');
    } else {
        logElement.textContent = 'ไม่มีประวัติการดำเนินการ';
    }
}
        // ในไฟล์ poolvilla1.html
// ... (ฟังก์ชันอื่น ๆ) ...

// Render Overview (Summary Stats)
// ✅ รับ result object ทั้งหมดเข้ามา
// ในไฟล์ poolvilla2.html
// ค้นหาฟังก์ชัน function renderOverview(result) { ... } แล้วแทนที่ทั้งหมด

// Render Overview (Summary Stats)
function renderOverview(result) {
        // 1. ✅ FIX: ดึงค่าและแสดงยอด Budget
    const totalBudgetAmount = parseFloat(result.totalBudget) || 0;
    const budgetElement = document.getElementById('total-budget-amount');
    
    if (budgetElement) {
        budgetElement.textContent = totalBudgetAmount.toLocaleString('th-TH', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    // 1. คำนวณยอดเงินที่ใช้ได้จริง (Available Balance)
    const availableBalanceAmount = parseFloat(result.availableBalance) || 0;
    const totalEstimateAmount = parseFloat(result.totalEstimate) || 0; // ✅ NEW
    
    const balanceElement = document.getElementById('balance-display');
    const balanceClass = availableBalanceAmount >= 0 ? 'balance-positive' : 'balance-negative';
    
    // ✅ FIX: แสดง Available Balance
    balanceElement.innerHTML = `
        ยอดเงินคงเหลือ (ใช้ได้จริง): 
        <div class="${balanceClass}">
            ${availableBalanceAmount.toLocaleString('th-TH', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            })} บาท
        </div>`;

    // 2. แสดงยอดประเมินจ่ายรวม (ถัดจาก ยอดเงินคงเหลือ)
    // เราจะใช้ div ใหม่ใต้ balance-display (ดู 2.2)
    const estimateDisplayElement = document.getElementById('estimate-total-display');
    if (estimateDisplayElement) {
        if (totalEstimateAmount > 0) {
            estimateDisplayElement.style.display = 'block';
            estimateDisplayElement.innerHTML = `
                ประเมินรายจ่ายล่วงหน้ารวม: 
                <span class="estimate-amount">${totalEstimateAmount.toLocaleString('th-TH', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                })} บาท</span>
            `;
        } else {
            estimateDisplayElement.style.display = 'none'; // ซ่อนถ้าไม่มีรายการ
        }
    }


    // 2. ✅ แสดงยอดผู้เข้าชมทั้งหมด (แก้ไข ID และการแสดงผล HTML)
    const visitorCount = parseInt(result.visitorCount) || 0;
    let visitorDetail = '';
    
    if (result.visitors && result.visitors.length > 0) {
        // ใช้ Set เพื่อดึงชื่อผู้ใช้ที่ไม่ซ้ำกัน (ยกเว้น System_Check)
        const uniqueUsers = [...new Set(result.visitors
            .map(v => v.User.toString().trim())
            .filter(u => u !== 'System_Check' && u !== 'System'))
        ];
        
        if (uniqueUsers.length > 0) {
            // ใช้ <br> และ inline style เพื่อจัดให้บรรทัดใหม่
            visitorDetail = `<br><span style="font-size: 0.6em; font-weight: normal; color: #6c757d;">เข้าชมโดย: ${uniqueUsers.join(', ')}</span>`;
        }
    }

    // ✅ แสดงผลรวมและรายละเอียดผู้เข้าชม (ใช้ ID: visitor-count)
    const visitorElement = document.getElementById('visitor-count'); 
    visitorElement.innerHTML = `${visitorCount} ครั้ง${visitorDetail}`;
}
        
        // Delete Transaction
        async function deleteTransaction(type, dataIndex) {
            if (!confirm(`คุณต้องการลบรายการ ${type} ในแถวที่ ${dataIndex + 1} นี้ใช่หรือไม่?`)) return;

            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            const payload = { 
                action: 'DELETE_TRANSACTION',
                user: user,
                rowIndex: dataIndex 
            };

            const result = await postData(payload);
            
            if (result.success) {
                showNotification('ลบรายการสำเร็จ', 'success');
            } else {
                showNotification(`ลบรายการล้มเหลว: ${result.message || 'ข้อผิดพลาด'}`, 'error');
            }
        }
        
        // Delete Estimate
        async function deleteEstimate(dataIndex) {
            if (!confirm(`คุณต้องการลบรายการประเมินในแถวที่ ${dataIndex + 1} นี้ใช่หรือไม่?`)) return;

            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            const payload = { 
                action: 'DELETE_ESTIMATE',
                user: user,
                rowIndex: dataIndex 
            };

            const result = await postData(payload);
            
            if (result.success) {
                showNotification('ลบรายการประเมินสำเร็จ', 'success');
            } else {
                showNotification(`ลบรายการประเมินล้มเหลว: ${result.message || 'ข้อผิดพลาด'}`, 'error');
            }
        }

        // ในไฟล์ poolvilla2.html
// ... (ต่อจาก async function deleteEstimate(dataIndex)) ...

// ✅ NEW: Forward Estimate to Transaction
async function forwardEstimate(dataIndex) {
    if (!confirm(`คุณต้องการเปลี่ยนรายการประเมินแถวที่ ${dataIndex + 1} เป็นรายการรายจ่ายจริงใช่หรือไม่? รายการเดิมจะถูกลบ`)) return;

    const user = localStorage.getItem(LOGGED_IN_USER_KEY);
    
    const payload = { 
        action: 'FORWARD_ESTIMATE',
        user: user,
        rowIndex: dataIndex 
    };

    showNotification('กำลังเปลี่ยนเป็นรายจ่ายจริง...', 'info', 60000); 
    const result = await postData(payload);
    
    if (result.success) {
        showNotification('บันทึกเป็นรายจ่ายจริงสำเร็จ', 'success');
        await loadAllData(); // โหลดข้อมูลใหม่เพื่ออัปเดตทั้ง 2 แท็บและยอดคงเหลือ
    } else {
        showNotification(`ดำเนินการล้มเหลว: ${result.message || 'ข้อผิดพลาด'}`, 'error');
    }
}

        // Initialize on load
        window.onload = checkAutoLogin;
    </script>
</body>
</html>





























