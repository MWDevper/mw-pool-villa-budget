<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (Google Sheets Backend)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        .header { text-align: center; margin-bottom: 20px; }
        .balance { font-size: 1.5em; font-weight: bold; padding: 10px; border: 2px solid #3498db; border-radius: 5px; margin-bottom: 20px; background-color: #eaf6ff; }
        .transaction-form, .estimate-form { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .transaction-list, .estimate-list { margin-top: 15px; }
        .transaction-item, .estimate-item { 
            display: grid; 
            grid-template-columns: 2fr 1fr 1.5fr 0.5fr; 
            gap: 10px; 
            padding: 8px 0; 
            border-bottom: 1px dotted #eee; 
            align-items: center;
        }
        .income { color: green; font-weight: bold; }
        .expense { color: red; font-weight: bold; }
        .estimate { color: orange; }
        .log-section { margin-top: 30px; padding: 10px; background-color: #f0f0f0; border-radius: 5px; }
        .log-section ul { list-style: none; padding: 0; }
        .log-section li { margin-bottom: 5px; font-size: 0.9em; border-bottom: 1px dotted #ccc; padding-bottom: 3px;}
    </style>
</head>
<body>
    <div id="auth-screen" style="text-align: center;">
        <h2>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: <span id="account-name-display">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></h2>
        <p>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏° (6 ‡∏´‡∏•‡∏±‡∏Å): <input type="password" id="passcode" maxlength="6" style="width: 100px;"></p>
        <p>‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <input type="text" id="username" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"></p>
        <button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div id="app-container" class="container" style="display: none;">
        <div class="header">
            <h1 id="current-account-name"></h1>
            <p>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="current-user"></span></p>
            <p>‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="viewer-list"></span></p>
        </div>

        <div class="balance">
            ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="current-balance">0.00</span> ‡∏ö‡∏≤‡∏ó
        </div>

        <div class="transaction-form">
            <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h3>
            <input type="number" id="amount" placeholder="‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô" style="width: 100px;">
            <input type="text" id="description" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
            <select id="type">
                <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
            </select>
            <button onclick="addTransaction()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        </div>

        <div class="estimate-form">
            <h3>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</h3>
            <input type="number" id="estimate-amount" placeholder="‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô" style="width: 100px;">
            <input type="text" id="estimate-desc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô">
            <button onclick="addEstimate()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>
        </div>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á)</h2>
                <div class="transaction-list" id="transaction-list"></div>
            </div>
            <div style="flex: 1;">
                <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏à‡∏≤‡∏Å‡∏á‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠)</h2>
                <div class="estimate-list" id="estimate-list"></div>
            </div>
        </div>

        <div class="log-section">
            <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
            <ul id="action-log"></ul>
        </div>

    </div>

    <script>
        // ====================================================================
        // *** ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ***
        // ====================================================================
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxWhIRoiAAcRLoR_vyPgSP9UoBXeOQvhZqCZ0GiTXUCEDqf65J-l7cVGFt9I5vwrUrIXA/exec'; 
        // ====================================================================
        
        let transactions = [];
        let estimates = [];
        let logs = [];
        let currentUser = '';
        let accountName = '';

        // ------------------------------------------------
        // API COMMUNICATION FUNCTIONS (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
        // ------------------------------------------------

        async function postData(payload) {
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP Error! Status: ${response.status}`);
                }

                const result = await response.json();
                return result;

            } catch (error) {
                console.error("Fetch/Server Connection Error:", error);
                // ‡∏™‡πà‡∏á Error ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏î‡πâ
                return { success: false, message: '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß' };
            }
        }

        async function refreshData() {
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ refresh ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà UI ‡∏à‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°
            if (!document.getElementById('app-container').style.display === 'block') return;

            const result = await postData({ action: 'GET_DATA' });
            if (result.success) {
                // Mapping ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                transactions = result.transactions.map(r => ({
                    timestamp: r[0], user: r[1], type: r[2], amount: parseFloat(r[3]), description: r[4]
                }));
                estimates = result.estimates.map(r => ({
                    timestamp: r[0], user: r[1], amount: parseFloat(r[2]), description: r[3]
                }));
                logs = result.logs.map(r => ({
                    timestamp: r[0], user: r[1], action: r[2]
                }));
                updateDisplay();
            } else {
                alert('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + result.message);
            }
        }

        // ------------------------------------------------
        // LOGIN & INITIAL LOAD
        // ------------------------------------------------

        async function login() {
            const passcode = document.getElementById('passcode').value;
            const user = document.getElementById('username').value.trim();

            if (user === '') {
                return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
            }
            
            const result = await postData({ action: 'LOGIN', passcode: passcode, user: user });

            if (result.success) {
                currentUser = user;
                accountName = result.accountName;
                document.getElementById('current-user').textContent = user;
                document.getElementById('current-account-name').textContent = accountName;
                
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                await refreshData();
            } else {
                alert('‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + result.message);
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏Å‡πà‡∏≠‡∏ô
        async function loadAccountName() {
            const result = await postData({ action: 'LOGIN', passcode: '000000', user: 'System' }); 
            
            if (result.success && result.accountName) {
                document.getElementById('account-name-display').textContent = result.accountName;
            } else {
                document.getElementById('account-name-display').textContent = result.message || 'Error: Check Apps Script URL';
            }
        }

        // ------------------------------------------------
        // DISPLAY & DATA MODIFICATION
        // ------------------------------------------------

        function updateDisplay() {
            // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
            let balance = transactions.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);
            document.getElementById('current-balance').textContent = balance.toFixed(2);

            // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
            const tList = document.getElementById('transaction-list');
            tList.innerHTML = '';
            transactions.forEach((t, index) => {
                const item = document.createElement('div');
                item.className = 'transaction-item ' + (t.type);
                item.innerHTML = `
                    <span>${t.description}</span>
                    <span>${t.type === 'income' ? '+' : '-'} ${t.amount.toFixed(2)} ‡∏ö‡∏≤‡∏ó</span>
                    <span>‡πÇ‡∏î‡∏¢: ${t.user}</span>
                    <button onclick="deleteTransaction(${index})" style="background: none; border: none; color: red; cursor: pointer;">‡∏•‡∏ö</button>
                `;
                tList.appendChild(item);
            });

            // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
            const eList = document.getElementById('estimate-list');
            eList.innerHTML = '';
            estimates.forEach((e, index) => {
                const item = document.createElement('div');
                item.className = 'estimate-item estimate';
                item.innerHTML = `
                    <span>(‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô) ${e.description}</span>
                    <span>${e.amount.toFixed(2)} ‡∏ö‡∏≤‡∏ó</span>
                    <span>‡πÇ‡∏î‡∏¢: ${e.user}</span>
                    <button onclick="forwardToTransaction(${index})" style="background: none; border: none; color: blue; cursor: pointer;">‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</button>
                    <button onclick="deleteEstimate(${index})" style="background: none; border: none; color: red; cursor: pointer;">‡∏•‡∏ö</button>
                `;
                eList.appendChild(item);
            });

            // 4. ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Log ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°
            updateActionLog();
        }

        function updateActionLog() {
            const aLog = document.getElementById('action-log');
            aLog.innerHTML = '';
            
            const viewerNames = [...new Set(logs.filter(log => log.action === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö').map(log => log.user))].join(', ');
            document.getElementById('viewer-list').textContent = viewerNames;
            
            logs.slice().reverse().forEach(log => {
                const li = document.createElement('li');
                li.textContent = `[${log.timestamp.split(',')[0]}] ${log.user} : ${log.action}`;
                aLog.appendChild(li);
            });
        }

        async function addTransaction() {
            if (!currentUser) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô");

            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value.trim();
            const type = document.getElementById('type').value;

            if (isNaN(amount) || amount <= 0 || description === '') {
                return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            }
            
            const result = await postData({ 
                action: 'ADD_TRANSACTION', user: currentUser, type: type, amount: amount, description: description
            });

            if (result.success) {
                document.getElementById('amount').value = '';
                document.getElementById('description').value = '';
                await refreshData();
            } else {
                 alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + result.message);
            }
        }

        async function deleteTransaction(index) {
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
            
            const result = await postData({ 
                action: 'DELETE_TRANSACTION', user: currentUser, rowIndex: index
            });

            if (result.success) {
                await refreshData();
            } else {
                 alert('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + result.message);
            }
        }
        
        async function addEstimate() {
            if (!currentUser) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô");

            const amount = parseFloat(document.getElementById('estimate-amount').value);
            const description = document.getElementById('estimate-desc').value.trim();

            if (isNaN(amount) || amount <= 0 || description === '') {
                return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            }

            const result = await postData({ 
                action: 'ADD_ESTIMATE', user: currentUser, amount: amount, description: description
            });

            if (result.success) {
                document.getElementById('estimate-amount').value = '';
                document.getElementById('estimate-desc').value = '';
                await refreshData();
            } else {
                 alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + result.message);
            }
        }

        async function deleteEstimate(index) {
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
            
            const result = await postData({ 
                action: 'DELETE_ESTIMATE', user: currentUser, rowIndex: index
            });

            if (result.success) {
                await refreshData();
            } else {
                 alert('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + result.message);
            }
        }

        async function forwardToTransaction(index) {
            if (!currentUser) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô");
            
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

            const result = await postData({ 
                action: 'FORWARD_ESTIMATE', user: currentUser, rowIndex: index
            });

            if (result.success) {
                await refreshData();
            } else {
                 alert('‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + result.message);
            }
        }
        
        document.addEventListener('DOMContentLoaded', loadAccountName);
    </script>
</body>
</html>

